<!DOCTYPE html>
<html lang="zxx" class="no-js">

<head>
  <!-- Mobile Specific Meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- Favicon-->
  <link rel="shortcut icon" href="img/fav.png">
  <!-- Author Meta -->
  <meta name="author" content="CodePixar">
  <!-- Meta Description -->
  <meta name="description" content="">
  <!-- Meta Keyword -->
  <meta name="keywords" content="">
  <!-- meta character set -->
  <meta charset="UTF-8">
  <!-- Site Title -->
  <title>Karma Shop</title>

  <!--
            CSS
            ============================================= -->
  <link rel="stylesheet" href="user/css/linearicons.css">
  <link rel="stylesheet" href="user/css/owl.carousel.css">
  <link rel="stylesheet" href="user/css/font-awesome.min.css">
  <link rel="stylesheet" href="user/css/themify-icons.css">
  <link rel="stylesheet" href="user/css/nice-select.css">
  <link rel="stylesheet" href="user/css/nouislider.min.css">
  <link rel="stylesheet" href="user/css/bootstrap.css">
  <link rel="stylesheet" href="user/css/main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
      .clean-btn {
        display: inline-block;
        padding: 10px 20px;
        background-color: #f2f2f2;
        border: none;
        color: #333;
        font-size: 16px;
        cursor: pointer;
      }
    
      .clean-btn:hover {
        background-color: #ddd;
      }
    </style>
    

</head>

<body>

  <!-- Start Header Area -->
  <header class="header_area sticky-header">
    <div class="main_menu">
      <nav class="navbar navbar-expand-lg navbar-light main_box">
        <div class="container">
          <!-- Brand and toggle get grouped for better mobile display -->
          <a class="navbar-brand logo_h" href="/"><img src="user/img/logo.png" alt=""></a>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <!-- Collect the nav links, forms, and other content for toggling -->
          <div class="collapse navbar-collapse offset" id="navbarSupportedContent">
            <ul class="nav navbar-nav menu_nav ml-auto">
              <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
              <li class="nav-item submenu dropdown active">
                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
                  aria-expanded="false">Shop</a>
                <ul class="dropdown-menu">
                  <li class="nav-item"><a class="nav-link" href="/products">Shop Category</a></li>
                  
                </ul>
              </li>
             
              <li class="nav-item submenu dropdown">
                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
                  aria-expanded="false">Pages</a>
                <ul class="dropdown-menu">
                  <li class="nav-item"><a class="nav-link" href="/logout">Logout</a></li>
                  <li class="nav-item"><a class="nav-link" href="/orders">Orders</a></li>
                </ul>
              </li>
              <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li class="nav-item"><a href="#" class="cart"><span class="ti-bag"></span></a></li>
              <li class="nav-item">
                <button class="search"><span class="lnr lnr-magnifier" id="search"></span></button>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </div>

    
  </header>
  <!-- End Header Area -->

  <!-- Start Banner Area -->
  <section class="banner-area organic-breadcrumb">
    <div class="container">
      <div class="breadcrumb-banner d-flex flex-wrap align-items-center justify-content-end">
        <div class="col-first">
          <h1>ckeckout</h1>
          <nav class="d-flex align-items-center">
            <a href="/">Home<span class="lnr lnr-arrow-right"></span></a>
            <a href="/singleorder">orders</a>
          </nav>
        </div>
      </div>
    </div>
  </section>
  <!-- End Banner Area -->
  
  <!--================Checkout =================-->
  
  <section class="cart_area">
    <div class="container">
        <div class="row ">
            

            <% data.forEach((value,index)=> { %>
                
                <div class="col-6 col-xl-5 mb-4 mt-0">
                    <div class="bg-light rounded h-100 p-4">
                        <h6 class="mb-4">Product <%= index+1 %>
                        </h6>
                        <div class="testimonial-item text-center">
                            
                            <img class="img-fluid  mx-auto mb-4"
                            src="/product_images/<%=value.productId.image[0]%>"
                            style="width: 100px; height: 100px;">
                            
                            <h5 class="mb-1">
                                <%= value.productId.productname %>
                           
                            </h5>
                            <p class="mb-0"><b>Quantity :<%= value.quantity %></b></p>
                            <p class="mb-0"><b>Total Amount :<%= value.productId.price * value.quantity %></b></p>
                            <p class="mb-0">
                                <%= value.productId.description %>
                            </p>
                        </div>
            
                    </div>
                </div>
                <% }) %>
            
            
                    <!-- <div class="col-sm-12 col-md-6 col-xl-6">
              <div class="h-100 bg-light rounded p-4">
                  <div class="d-flex align-items-center justify-content-between mb-2">
                      <h5 class="mb-0">Delivery Address </h5>
                  </div>
                  <div class="d-flex align-items-center border-bottom py-3">
                      <div class="row">
                          
                          <div class="col-12">
                              <h6>Id : <%= orderData._id %></h6>
                          </div>
                          <div class="col-12">
                              <h6>Payment Method : <%= orderData.paymentMethod %></h6>
                          </div>
                          <div class="col-12">
                              <h6>Address : <%= orderData.deliveryDetails %></h6>
                          </div>
                          
                      </div>
                  </div>
              </div>
            </div> -->
            
            
            
                    <div class="col-6 col-xl-5 mb-4 cart-wrap ftco-animate mx-4">
            
                        <div class="cart-total mb-3">
            
                            <h5 class="mb-3">Delivery Address </h5>
                            <p class="d-flex">
                                <span>Address: </span>
                                <span>
                                    <%= orderData.deliveryDetails%>
                                </span>
                            </p>
            
                        </div>
            
                        <div class="cart-total mb-3">
            
                            <p class="d-flex">
                                <span>Subtotal</span>
                                <span>₹<%= orderData.totalBefore%></span>
                            </p>
                            <p class="d-flex">
                                <span>Delivery</span>
                                <span>₹0.00</span>
                            </p>
                            <p class="d-flex">
                                <span>Discount</span>
                                <span>₹<%= orderData.discount%> (<%= orderData.couponCode%>)</span>
                            </p>
                            <p class="d-flex">
                                <span>Wallet</span>
                                <span>₹<%= orderData.wallet%></span>
                            </p>
                            <hr>
                            <p class="d-flex total-price">
                                <span>Total</span>
                                <span>₹<%= orderData.totalAmount%></span>
                            </p>
                        </div>
            
            
                    </div>
            
            </div>

    




      
       
    </div>
  </section>
  
  
  <!--================End Checkout =================-->


  <script src="user/js/vendor/jquery-2.2.4.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"
    integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GRAUWErUbiGz1nFJtM8RTb4vKuojKBpggD4"
    crossorigin="anonymous"></script>
  <script src="user/js/vendor/bootstrap.min.js"></script>
  <script src="user/js/jquery.ajaxchimp.min.js"></script>
  <script src="user/js/jquery.nice-select.min.js"></script>
  <script src="user/js/jquery.sticky.js"></script>
  <script src="user/js/nouislider.min.js"></script>
  <script src="user/js/jquery.magnific-popup.min.js"></script>
  <script src="user/js/owl.carousel.min.js"></script>
  <!--gmaps Js-->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCjCGmQ0Uq4exrzdcL6rvxywDDOvfAu6eE"></script>
  <script src="user/js/gmaps.min.js"></script>
  <script src="user/js/main.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
   $(document).ready(function () {
      var quantitiy = 0;
      $(".quantity-right-plus").click(function (e) {
        // Stop acting like a button
        e.preventDefault();
        // Get the field name
        var quantity = parseInt($("#quantity").val());

        // If is not undefined

        $("#quantity").val(quantity + 1);

        // Increment
      });

      $(".quantity-left-minus").click(function (e) {
        // Stop acting like a button
        e.preventDefault();
        // Get the field name
        var quantity = parseInt($("#quantity").val());

        // If is not undefined

        // Increment
        if (quantity > 0) {
          $("#quantity").val(quantity - 1);
        }
      });
    });
  </script>
  <script>
    $("#place-order").submit((e) => {
      const allTotal = document.getElementById("total").innerHTML
      const walletPlace = document.getElementById("wallet").innerHTML
      const amount = document.getElementById("total-amount").innerHTML
      const address = $("input[name=address]:checked").val()
      const paymentMethod = $("input[name=payment]:checked").val();
      e.preventDefault()
      $.ajax({
        url: "/placeorder",
        method: 'post',
        data: {
          total: amount,
          address: address,
          payment: paymentMethod,
          wallet: walletPlace
        },
        success: (response) => {
          console.log(response.order);
          if (response.codSuccess == true) {
            window.location.href = "/orderplaced";
          } else if (response.codFailed == true) {
            swal("Oops!", "Add Address", "error");
          } else {
            if (response.error && response.error === 'ZeroQuantityError') {
              swal("Oops!", "Cannot order a product with zero quantity", "error");
            } else {
              console.log(response.order);
              razorPay(response.order);
            }
          }
        },
        error: (error) => {
          swal("Oops!", "An error occurred", "error");
          console.log(error);
        }
      })
    })
  </script>
  
  <script>
    function razorPay(order) {
      var options = {
        "key": "rzp_test_xhTD3DssF9089g", // Enter the Key ID generated from the Dashboard
        "amount": order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
        "currency": "INR",
        "name": "karama", //your business name
        "description": "Test Transaction",
        "image": "#",
        "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
        // "callback_url": "https://eneqd3r9zrjok.x.pipedream.net/",
        "handler": function (response) {
          verifyPayment(response, order)
        },
        "prefill": {
          "name": "Gaurav Kumar", //your customer's name
          "email": "gaurav.kumar@example.com",
          "contact": "9000090000"
        },
        "notes": {
          "address": "Razorpay Corporate Office"
        },
        "theme": {
          "color": "#3399cc"
        }
      }

      var rzp1 = new Razorpay(options);
      rzp1.open();
    }
    function verifyPayment(payment, order) {
      $.ajax({
        url: "/verifyPayment",
        method: 'post',
        data: {
          payment,
          order
        },
        success: (response) => {
          if (response.success == true) {
            window.location.href = "/orderplaced";
          } else if (response.onlineSuccess) {
            Swal.fire({
              icon: 'error',
              title: 'Payment has done',
              showConfirmButton: false,
              timer: 1500
            })
          }
        }

      })
    }

    
  </script>
  
 <script>
  function applyCoupon(code) {
      let amount = document.getElementById("total").innerHTML
      $.ajax({
        url: '/applycoupon',
        method: 'post',
        data: {
          code: code,
          amount: amount
        },
        success: (response) => {
          if (response.invalid) {
            swal("Oops!", "Coupon not found.", "error");
          } else if (response.expire) {
            swal("Oops!", "Coupon has expired.", "error");
          } else if (response.cartamount) {
            swal("Oops!", "Minimum Amount.", "error");
          } else if (response.user) {
            swal("Oops!", "Coupon used", "error");
          }else if (response.limit){
            swal("Oops!", "Coupon limit reached", "error");
          }else if (response.couponokey) {
            document.getElementById("coupondiscount").innerHTML = `${response.discountvalue}% <p style="color:green">Discount added</p>`;
            // document.getElementById("coupondiscount").innerHTML = `2`;

            document.getElementById("total-amount").innerHTML = `${response.distotal}`
            // document.getElementById("total-amount").innerHTML = `10`

            swal("Success!", "Coupon Added.", "success");
          }


        }
      })

    }
 </script>
  </script>
 
  <script>

  </script>
</div>
</body>

</html>

<script>
  function checkWallet() {
    // Retrieve necessary elements
    let walletPlace = document.getElementById("wallet");
    let amount = parseInt(document.getElementById("total-amount").innerHTML); // Convert to integer
    let totalAmount = parseInt(document.getElementById("total-amount"))
    // let radioDiv = document.getElementById("radio_div");

    // Make an AJAX request to the server
    $.ajax({
      url: '/checkWallet',
      method: 'post',
      success: (response) => {
        if (response.success) {
          window.location.href = "/orderplaced";

          console.log("success");

          if (response.wallet > amount) {
            // Sufficient balance, deduct payment from wallet
            response.wallet -= amount;
            walletPlace.innerHTML = response.wallet;
          }

          let remainingAmount = amount - response.wallet;

          if (remainingAmount < 0) {
   totalAmount.innerHTML = 10;
  radioDiv.style.display = "none"; // Hide the radioDiv element
} else {
  totalAmount.innerHTML = remainingAmount;
  radioDiv.style.display = "block"; // Show the radioDiv element if needed
}

        } else {
          console.log("fail");
        }
      }
    });
  }
</script>
