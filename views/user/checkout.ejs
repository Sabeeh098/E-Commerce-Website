<!DOCTYPE html>
<html lang="zxx" class="no-js">

<head>
  <!-- Mobile Specific Meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- Favicon-->
  <link rel="shortcut icon" href="img/fav.png">
  <!-- Author Meta -->
  <meta name="author" content="CodePixar">
  <!-- Meta Description -->
  <meta name="description" content="">
  <!-- Meta Keyword -->
  <meta name="keywords" content="">
  <!-- meta character set -->
  <meta charset="UTF-8">
  <!-- Site Title -->
  <title>Karma Shop</title>

  <!--
            CSS
            ============================================= -->
  <link rel="stylesheet" href="user/css/linearicons.css">
  <link rel="stylesheet" href="user/css/owl.carousel.css">
  <link rel="stylesheet" href="user/css/font-awesome.min.css">
  <link rel="stylesheet" href="user/css/themify-icons.css">
  <link rel="stylesheet" href="user/css/nice-select.css">
  <link rel="stylesheet" href="user/css/nouislider.min.css">
  <link rel="stylesheet" href="user/css/bootstrap.css">
  <link rel="stylesheet" href="user/css/main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
      .clean-btn {
        display: inline-block;
        padding: 10px 20px;
        background-color: #f2f2f2;
        border: none;
        color: #333;
        font-size: 16px;
        cursor: pointer;
      }
    
      .clean-btn:hover {
        background-color: #ddd;
      }
    </style>
    

</head>

<body>

  <!-- Start Header Area -->
  <header class="header_area sticky-header">
    <div class="main_menu">
      <nav class="navbar navbar-expand-lg navbar-light main_box">
        <div class="container">
          <!-- Brand and toggle get grouped for better mobile display -->
          <a class="navbar-brand logo_h" href="/"><img src="user/img/logo.png" alt=""></a>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <!-- Collect the nav links, forms, and other content for toggling -->
          <div class="collapse navbar-collapse offset" id="navbarSupportedContent">
            <ul class="nav navbar-nav menu_nav ml-auto">
              <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
              <li class="nav-item submenu dropdown active">
                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
                  aria-expanded="false">Shop</a>
                <ul class="dropdown-menu">
                  <li class="nav-item"><a class="nav-link" href="category.html">Shop Category</a></li>
                  <li class="nav-item"><a class="nav-link" href="single-product.html">Product
                      Details</a></li>
                  <li class="nav-item"><a class="nav-link" href="checkout.html">Product Checkout</a>
                  </li>
                  <li class="nav-item active"><a class="nav-link" href="cart">Shopping Cart</a>
                  </li>
                  <li class="nav-item"><a class="nav-link" href="confirmation.html">Confirmation</a>
                  </li>
                </ul>
              </li>
              <li class="nav-item submenu dropdown">
                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
                  aria-expanded="false">Blog</a>
                <ul class="dropdown-menu">
                  <li class="nav-item"><a class="nav-link" href="blog.html">Blog</a></li>
                  <li class="nav-item"><a class="nav-link" href="single-blog.html">Blog Details</a>
                  </li>
                </ul>
              </li>
              <li class="nav-item submenu dropdown">
                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
                  aria-expanded="false">Pages</a>
                <ul class="dropdown-menu">
                  <li class="nav-item"><a class="nav-link" href="login.html">Login</a></li>
                  <li class="nav-item"><a class="nav-link" href="tracking.html">Tracking</a></li>
                  <li class="nav-item"><a class="nav-link" href="elements.html">Elements</a></li>
                </ul>
              </li>
              <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li class="nav-item"><a href="#" class="cart"><span class="ti-bag"></span></a></li>
              <li class="nav-item">
                <button class="search"><span class="lnr lnr-magnifier" id="search"></span></button>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </div>

    
  </header>
  <!-- End Header Area -->

  <!-- Start Banner Area -->
  <section class="banner-area organic-breadcrumb">
    <div class="container">
      <div class="breadcrumb-banner d-flex flex-wrap align-items-center justify-content-end">
        <div class="col-first">
          <h1>ckeckout</h1>
          <nav class="d-flex align-items-center">
            <a href="index.html">Home<span class="lnr lnr-arrow-right"></span></a>
            <a href="cart">Cart</a>
          </nav>
        </div>
      </div>
    </div>
  </section>
  <!-- End Banner Area -->
  
  <!--================Checkout =================-->
  
  <section class="cart_area">
    <div class="container">


      <!-- add Modal -->
      <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Add address</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form action="/addAddress" class="billing-form" method="post">
                <h3 class="mb-4 billing-heading">Billing Details</h3>
                <div class="row align-items-end">
                  <div class="col-12">
                    <div class="form-group">
                      <label for="firstname">Name</label>
                      <input type="text" class="form-control" placeholder="" name="name" required />
                    </div>
                  </div>
                  <div class="w-100"></div>
                  <div class="col-6">
                    <div class="form-group">
                      <label for="country">Country</label>
                      <div class="select-wrap">
                        <div class="icon">
                          <span class="ion-ios-arrow-down"></span>
                        </div>
                        <select id="" class="form-control" name="country" required>
                          <option value="France">France</option>
                          <option value="India">India</option>
                          <option value="Philippines">Philippines</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="towncity">Town / City</label>
                      <input type="text" class="form-control" placeholder="" name="town" required>
                    </div>
                  </div>
                  <div class="w-100"></div>
                  <div class="col-12">
                    <div class="form-group">
                      <label for="streetaddress">Street Address</label>
                      <input type="text" class="form-control" placeholder="House number and street name" name="street"
                        required />
                    </div>
                  </div>
                  <div class="w-100"></div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="postcodezip">Postcode / ZIP *</label>
                      <input type="text" class="form-control" placeholder="" name="postcode" required />
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="phone">Phone</label>
                      <input type="text" class="form-control" placeholder="" name="phone" required />
                    </div>
                  </div>
                </div>

            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" data-dismiss="modal">
                Close
              </button>
              <button type="submit" class="btn btn-primary">Save changes</button>
            </div>
            </form>
          </div>
        </div>
      </div>





      <section class="ftco-section">
        <div class="container">
          <div class="row justify-content-center">
            <div class="col-xl-10 ftco-animate">
              <form action="/orderplaced" method="get" id="place-order">
                <div class="test d-flex ">
                  <div class="col-lg-6 col-md-6 ">
                    <% address.forEach((value)=>{ %>
                      <div class="form-check mb-2">
                        <div class="row">
                          <div class="col-10">
                            <input class="form-check-input" name="address" type="radio"
                              value=" <%= value.name%>,<%= value.street %>, <%= value.town %> <%= value.country %>, <%= value.postcode %>, <%= value.phone %>"
                              id="flexCheckDefault" required>
                            <label class="form-check-label" for="flexCheckDefault">
                              <%= value.name%>,<br>
                                <%= value.street %> ,
                                  <%= value.town %>,
                                    <%= value.country %>
                                      <%= value.postcode %> <br>
                                        <%= value.phone %>
                            </label>
                          </div>
                          <div class="col-2">
                            <a href="/delete-address?id=<%=value._id%>">
                              <i class="fas fa-trash"></i> 
                            </a>
                          </div>
                          <div class="col-2">
                            <a href="/editadress?id=<%=value._id%>" data-target="#Modal">
                              <i class="fas fa-edit"></i> 
                            </a>
                          </div>
                        </div>
                      </div>
                      <%}) %>

                      <button type="button" class="primary-btn  mt-3" style="outline: none; border: 0" data-toggle="modal" data-target="#exampleModal">
                        Add Address
                      </button>
                  </div>
  
                  <div class="col-md-6 mx-5">
                    <div class="cart-detail bg-light p-3 p-md-4 h-100">
                      <h3 class="billing-heading mb-4">Payment Method</h3>
                      <div class="form-group">
                        <div class="col-md-12">
                          <div class="radio">
                            <label><input type="radio" value="cod" name="payment" class="mr-2" checked />
                              COD</label>
                          </div>
                        </div>
                      </div>
                      <div class="form-group">
                        <div class="col-md-12">
                          <div class="radio">
                            <label><input type="radio" value="online" name="payment" class="mr-2" />
                              Online Payment</label>
                          </div>
                        </div>
                      </div>
                      <%if(wallet !==0){ %>
                        <div class="form-group">
                          <div class="col-md-12">
                            <div class="radio " id="radio_div">
                              <label><input type="radio" value="wallet" name="payment" class="mr-2"
                                  onclick="checkWallet()" />
                                Wallet</label>
                            </div>
                          </div>
                        </div>
                        <% } %>

                          <p>
                            <button type="submit" class="genric-btn primary" >Place an order</button>
                          </p>

                       </div>
                      </div>
                  
  
  
                  

                </div>
                


                <div class="col-6 my-5">

                  <div class="input-group">
                    <input type="text" id="code" class="cart-detail cart-total bg-light p-3 p-md-4 form-control"
                      placeholder="Coupon Code" />
                    <div class="input-group-append">
                      <a class="genric-btn primary text-light" onclick="applyCoupon($('#code').val())">Apply
                        Coupon</a>
                    </div>

                  </div>

                </div>
                <div class="row mt-5 pt-3 d-flex">

                  <div class="col-md-6 d-flex">
                    <div class="cart-detail cart-total bg-light p-3 p-md-4 w-100">
                      <h3 class="billing-heading mb-4">Cart Total</h3>
                      <p class="d-flex">
                        <span>Subtotal :</span>
                        ₹
                        <span id="total">
                          <%= total%>
                        </span>
                      </p>
                      <p class="d-flex">
                        <span>Delivery :</span>
                        <span>$0.00</span>
                      </p>
                      <p class="d-flex">
                        <span>Wallet :</span>
                        ₹
                        <span id="wallet">0.00</span>
                      </p>
                      <div class="d-flex flex-row justify-content-between">
                        <span>Discount :</span>
                        <span id="coupondiscount" style="color:#e5380d"></span>
                        
                      </div>

                      <hr />
                      <p class="d-flex ">
                        <span>Total :</span>
                        ₹
                        <span id="total-amount">
                          <%=total%>
                        </span>
                      </p>
                    </div>
                  </div>
                  
              </form>
        </div>
    </div>
    <!-- .col-md-8 -->
    </div>
    </div>
  </section>
  
  
  <!--================End Checkout =================-->


  <script src="user/js/vendor/jquery-2.2.4.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"
    integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GRAUWErUbiGz1nFJtM8RTb4vKuojKBpggD4"
    crossorigin="anonymous"></script>
  <script src="user/js/vendor/bootstrap.min.js"></script>
  <script src="user/js/jquery.ajaxchimp.min.js"></script>
  <script src="user/js/jquery.nice-select.min.js"></script>
  <script src="user/js/jquery.sticky.js"></script>
  <script src="user/js/nouislider.min.js"></script>
  <script src="user/js/jquery.magnific-popup.min.js"></script>
  <script src="user/js/owl.carousel.min.js"></script>
  <!--gmaps Js-->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCjCGmQ0Uq4exrzdcL6rvxywDDOvfAu6eE"></script>
  <script src="user/js/gmaps.min.js"></script>
  <script src="user/js/main.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
   $(document).ready(function () {
      var quantitiy = 0;
      $(".quantity-right-plus").click(function (e) {
        // Stop acting like a button
        e.preventDefault();
        // Get the field name
        var quantity = parseInt($("#quantity").val());

        // If is not undefined

        $("#quantity").val(quantity + 1);

        // Increment
      });

      $(".quantity-left-minus").click(function (e) {
        // Stop acting like a button
        e.preventDefault();
        // Get the field name
        var quantity = parseInt($("#quantity").val());

        // If is not undefined

        // Increment
        if (quantity > 0) {
          $("#quantity").val(quantity - 1);
        }
      });
    });
  </script>
  <script>
    $("#place-order").submit((e) => {
      const allTotal = document.getElementById("total").innerHTML
      const walletPlace = document.getElementById("wallet").innerHTML
      const amount = document.getElementById("total-amount").innerHTML
      const address = $("input[name=address]:checked").val()
      const paymentMethod = $("input[name=payment]:checked").val();
      e.preventDefault()
      $.ajax({
        url: "/placeorder",
        method: 'post',
        data: {
          total: amount,
          address: address,
          payment: paymentMethod,
          wallet: walletPlace
        },
        success: (response) => {
          console.log(response.order);
          if (response.codSuccess == true) {
            window.location.href = "/orderplaced";
          } else if (response.codFailed == true) {
            swal("Oops!", "Add Address", "error");
          } else {
            if (response.error && response.error === 'ZeroQuantityError') {
              swal("Oops!", "Cannot order a product with zero quantity", "error");
            } else {
              console.log(response.order);
              razorPay(response.order);
            }
          }
        },
        error: (error) => {
          swal("Oops!", "An error occurred", "error");
          console.log(error);
        }
      })
    })
  </script>
  
  <script>
    function razorPay(order) {
      var options = {
        "key": "rzp_test_xhTD3DssF9089g", // Enter the Key ID generated from the Dashboard
        "amount": order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
        "currency": "INR",
        "name": "karama", //your business name
        "description": "Test Transaction",
        "image": "#",
        "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
        // "callback_url": "https://eneqd3r9zrjok.x.pipedream.net/",
        "handler": function (response) {
          
          verifyPayment(response, order)
        },
        "prefill": {
          "name": "Gaurav Kumar", //your customer's name
          "email": "gaurav.kumar@example.com",
          "contact": "9000090000"
        },
        "notes": {
          "address": "Razorpay Corporate Office"
        },
        "theme": {
          "color": "#3399cc"
        }
      }
      var rzp1 = new Razorpay(options);
rzp1.on('payment.failed', function (response){
        // alert(response.error.code);
        // alert(response.error.description);
        // alert(response.error.source);
        // alert(response.error.step);
        // alert(response.error.reason);
        // alert(response.error.metadata.order_id);
        // alert(response.error.metadata.payment_id);
        window.location.href = "/orderfailed";
});
      // var rzp1 = new Razorpay(options);
      rzp1.open();
    }
    function verifyPayment(payment, order) {
      $.ajax({
        url: "/verifyPayment",
        method: 'post',
        data: {
          payment,
          order
        },
        success: (response) => {
          if (response.success == true) {
            console.log('here1');
            window.location.href = "/orderplaced";
          } else if (response.onlineSuccess) {
            Swal.fire({
              icon: 'error',
              title: 'Payment has done',
              showConfirmButton: false,
              timer: 1500
            })
          }
        }

      })
    }

    
  </script>
  
 <script>
  function applyCoupon(code) {
      let amount = document.getElementById("total").innerHTML
      $.ajax({
        url: '/applycoupon',
        method: 'post',
        data: {
          code: code,
          amount: amount
        },
        success: (response) => {
          if (response.invalid) {
            swal("Oops!", "Coupon not found.", "error");
          } else if (response.expire) {
            swal("Oops!", "Coupon has expired.", "error");
          } else if (response.cartamount) {
            swal("Oops!", "Minimum Amount.", "error");
          } else if (response.user) {
            swal("Oops!", "Coupon used", "error");
          }else if (response.limit){
            swal("Oops!", "Coupon limit reached", "error");
          }else if (response.couponokey) {
            document.getElementById("coupondiscount").innerHTML = `${response.discountvalue}% <p style="color:green">Discount added</p>
            <p class="text-end"> <a href="/checkout"> Remove coupon </a></p>`;
            // document.getElementById("coupondiscount").innerHTML = `2`;

            document.getElementById("total-amount").innerHTML = `${response.distotal}`
            // document.getElementById("total-amount").innerHTML = `10`

            swal("Success!", "Coupon Added.", "success");
          }


        }
      })

    }
 </script>
  </script>
 

</div>
</body>

</html>

<script>
  function checkWallet() {
    let walletPlace = document.getElementById("wallet");
    let amount = parseInt(document.getElementById("total-amount").innerHTML); // Convert to integer
    let totalAmount = parseInt(document.getElementById("total-amount").innerHTML);
    $.ajax({
      url: '/checkWallet',
      method: 'post',
      data:{
        amount:totalAmount
      },
      
      success: (response) => {
        if (response.success) {
          console.log("successojejhwfhggsgg"); 
        } else {
          console.log("fail");
        }
      }
    });
  }
</script>
